<div class="container task-list-container" style="margin-top: 20px;">
  <div style="display: flex; justify-content: space-between; align-items: center;"> <!-- Eliminado margin-bottom -->
    <h2 class="blue-text text-darken-2" style="margin: 0;">Lista de Tareas</h2>
    <a class="btn waves-effect waves-light blue" routerLink="/form-task" title="Crear Nueva Tarea">
      Agregar Tarea
      <i class="material-icons right">add</i>
    </a>
  </div>

  <div *ngIf="isLoading" class="progress blue lighten-4">
    <div class="indeterminate blue"></div>
  </div>

  <!-- Usaremos collapsible popout para un look clásico pero funcional -->
  <ul class="collapsible popout" *ngIf="!isLoading && tasks.length > 0">
    <li *ngFor="let task of tasks; let i = index">
      <!-- Cabecera del Collapsible (Clickable) -->
      <div class="collapsible-header waves-effect">
        <i class="material-icons task-icon">assignment</i>
        <span class="task-title">{{ task.nombre }}</span>
        <!-- Badge de estado -->
        <span class="task-status-badge" [ngClass]="getStatusClass(task.estado)">{{ task.estado }}</span>
        <!-- Icono indicador (opcional, Materialize lo maneja) -->
        <!-- <i class="material-icons expand-icon">arrow_drop_down</i> -->
      </div>

      <!-- Cuerpo del Collapsible (Contenido) -->
      <div class="collapsible-body">
        <div class="task-details">
          <!-- Descripción -->
          <p *ngIf="task.descripcion"><strong>Descripción:</strong> {{ task.descripcion }}</p>
          <p *ngIf="!task.descripcion"><em>No hay descripción disponible.</em></p>

          <!-- Fecha Límite -->
          <p *ngIf="task.fechaLimite"><strong>Fecha Límite:</strong> {{ task.fechaLimite | date:'dd/MM/yyyy' }}</p>
          <p *ngIf="!task.fechaLimite"><em>No se especificó fecha límite.</em></p>

          <!-- Archivo Adjunto -->
          <div *ngIf="task.filePath" class="file-attachment">
            <strong>Archivo Adjunto:</strong>
            <button class="btn-flat waves-effect waves-teal btn-small download-btn" (click)="downloadFile(task.id, task.fileName, $event)" title="Descargar {{ task.fileName }}">
              <i class="material-icons left tiny">file_download</i> {{ task.fileName }}
            </button>
          </div>
          <p *ngIf="!task.filePath"><em>No hay archivo adjunto.</em></p>

          <!-- Acciones -->
          <div class="task-actions">
            <!-- Botón Editar (si se implementa) -->
            <!-- <button class="btn waves-effect waves-light amber btn-small action-btn">Editar <i class="material-icons right tiny">edit</i></button> -->
            <!-- Botón Eliminar -->
            <button class="btn waves-effect waves-light red btn-small action-btn" (click)="askForDeleteConfirmation(task.id, i, task.nombre, $event)">
              Eliminar <i class="material-icons right tiny">delete</i>
            </button>
          </div>
        </div>
      </div>
    </li>
  </ul>

  <!-- Mensaje si no hay tareas -->
  <div *ngIf="!isLoading && tasks.length === 0" class="center-align no-tasks-message">
    <i class="material-icons large grey-text text-lighten-1">inbox</i>
    <p class="grey-text">No tienes tareas pendientes.</p>
    <a class="btn waves-effect waves-light blue" routerLink="/form-task">
      Crea tu primera tarea
    </a>
  </div>
</div>

<!-- Popup de Confirmación -->
<app-confirmation-popup
  [isVisible]="showConfirmationPopup"
  [title]="popupTitle"
  [question]="popupQuestion"
  [primaryActionText]="'Eliminar'"
  [secondaryActionText]="'Cancelar'"
  (primaryAction)="confirmDelete()"
  (secondaryAction)="cancelDelete()">
</app-confirmation-popup>